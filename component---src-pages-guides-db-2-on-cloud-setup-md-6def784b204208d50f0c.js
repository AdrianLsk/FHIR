(window.webpackJsonp=window.webpackJsonp||[]).push([[14,17],{"013z":function(e,t,a){"use strict";a("HQhv"),a("sC2a");var n=a("qKvR"),r=a("pOBw"),i=a("q1tI"),o=a.n(i),c=a("huSw"),l=a("t0dz"),s=a.n(l),b=a("Bfmn"),d=a("a7k6"),u=a("TSYQ"),p=a.n(u),h=a("QH2O"),m=function(e){var t,a=e.children,r=e.title,i=e.tabs,o=void 0===i?[]:i,c=e.shouldHideHeader;return Object(n.b)("div",{className:p()((t={},t[h.pageHeader]=h.pageHeader,t[h.pageHeaderSticky]=o.length,t[h.pageHeaderShifted]=c,t))},Object(n.b)("div",{className:"bx--grid"},Object(n.b)("div",{className:"bx--row"},Object(n.b)("div",{className:"bx--col-lg-12"},Object(n.b)("h1",{id:"page-title",className:h.text},r)))),a)},O=a("Z3H1"),j=a("BAC9"),f=function(e){var t=e.relativePagePath,a=e.repository,r=O.data.site.siteMetadata.repository,i=a||r,o=i.baseUrl,c=o+"/tree/master"+i.subDirectory+"/src/pages"+t;return o?Object(n.b)("div",{className:"bx--row "+j.row},Object(n.b)("div",{className:"bx--col"},Object(n.b)("a",{className:j.link,href:c},"Edit this page on GitHub"))):null},g=a("FCXl"),y=(a("q8oJ"),a("8npG"),a("nWfQ"),a("Wbzz")),N=a("I8xM");var v=function(e){var t,a;a=e,(t=r).prototype=Object.create(a.prototype),t.prototype.constructor=t,t.__proto__=a;!function(e){function t(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}}(r);function r(){return e.apply(this,arguments)||this}return r.prototype.render=function(){var e=this.props,t=e.tabs,a=e.slug,r=a.split("/").filter(Boolean).slice(-1)[0],i=t.map((function(e){var t,i=s()(e,{lower:!0}),o=i===r,c=a.replace(r,i);return Object(n.b)("li",{key:e,className:p()((t={},t[N.selectedItem]=o,t),N.listItem)},Object(n.b)(y.Link,{className:N.link,to:""+c},e))}));return Object(n.b)("div",{className:N.tabsContainer},Object(n.b)("div",{className:"bx--grid"},Object(n.b)("div",{className:"bx--row"},Object(n.b)("div",{className:"bx--col-lg-12 bx--col-no-gutter"},Object(n.b)("nav",null,Object(n.b)("ul",{className:N.list},i))))))},r}(o.a.Component),I=a("MjG9");t.a=function(e){var t=e.pageContext,a=e.children,i=e.location,o=t.frontmatter,l=void 0===o?{}:o,u=t.relativePagePath,p=l.tabs,h=l.title,O=Object(b.c)(),j=!!p&&"down"===O,y=r.data.site.pathPrefix,N=y?i.pathname.replace(y,""):i.pathname,x=p?N.split("/").slice(-1)[0]||s()(p[0],{lower:!0}):"";return Object(n.b)(d.a,{shouldHideHeader:j,homepage:!1},Object(n.b)(m,{shouldHideHeader:j,title:h,label:"label",tabs:p},p&&Object(n.b)(v,{slug:N,tabs:p,currentTab:x})),Object(n.b)(I.a,{padded:!0},a,Object(n.b)(f,{relativePagePath:u})),Object(n.b)(g.a,{pageContext:t,location:i,slug:N,tabs:p,currentTab:x}),Object(n.b)(c.a,null))}},BAC9:function(e,t,a){e.exports={bxTextTruncateEnd:"EditLink-module--bx--text-truncate--end--2pqje",bxTextTruncateFront:"EditLink-module--bx--text-truncate--front--3_lIE",link:"EditLink-module--link--1qzW3",row:"EditLink-module--row--1B9Gk"}},I8xM:function(e,t,a){e.exports={bxTextTruncateEnd:"PageTabs-module--bx--text-truncate--end--267NA",bxTextTruncateFront:"PageTabs-module--bx--text-truncate--front--3xEQF",tabsContainer:"PageTabs-module--tabs-container--8N4k0",list:"PageTabs-module--list--3eFQc",listItem:"PageTabs-module--list-item--nUmtD",link:"PageTabs-module--link--1mDJ1",selectedItem:"PageTabs-module--selected-item--YPVr3"}},QH2O:function(e,t,a){e.exports={bxTextTruncateEnd:"PageHeader-module--bx--text-truncate--end--mZWeX",bxTextTruncateFront:"PageHeader-module--bx--text-truncate--front--3zvrI",pageHeader:"PageHeader-module--page-header--3hIan",text:"PageHeader-module--text--o9LFq",pageHeaderSticky:"PageHeader-module--page-header--sticky--1ElAE",pageHeaderShifted:"PageHeader-module--page-header--shifted--1sRXO"}},YTXH:function(e,t,a){"use strict";a.r(t),a.d(t,"_frontmatter",(function(){return o})),a.d(t,"default",(function(){return s}));a("E5k/"),a("rzGZ"),a("Dq+y"),a("8npG"),a("Ggvi"),a("qKvR"),a("q1tI");var n=a("E/Ix"),r=a("013z");function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}var o={},c={_frontmatter:o},l=r.a;function s(e){var t=e.components,a=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,["components"]);return Object(n.b)(l,i({},c,a,{components:t,mdxType:"MDXLayout"}),Object(n.b)("h2",{id:"using-db2-for-persistence"},"Using Db2 for persistence"),Object(n.b)("p",null,"This document walks a developer or administrator through the steps necessary to setup and configure IBM Db2 on IBM Cloud for the IBM FHIR Server."),Object(n.b)("h3",{id:"create-a-db2-instance"},"Create a Db2 instance"),Object(n.b)("p",null,"Log in to your IBM Cloud account ",Object(n.b)("a",i({parentName:"p"},{href:"https://cloud.ibm.com/"}),"https://cloud.ibm.com/"),"."),Object(n.b)("p",null,"Click ",Object(n.b)("inlineCode",{parentName:"p"},"Create resource"),"."),Object(n.b)("p",null,"Choose ",Object(n.b)("inlineCode",{parentName:"p"},"Db2 (transactional)"),"."),Object(n.b)("p",null,"Select the instance size. Flex is the best choice for a basic production workload."),Object(n.b)("p",null,"You can use the Lite plan for development or evaluation workloads. This plan has a limit of 5 concurrent connections; the IBM FHIR server connection-pool needs to be sized accordingly to avoid failures."),Object(n.b)("h3",{id:"scale-the-instance"},"Scale the Instance"),Object(n.b)("p",null,"If you chose Flex, you may want to scale the instance after it has been created (e.g. 4 cores, 16GB). The instance can be scaled more than once, so it doesn’t matter if you don’t get the sizing right first time. Scaling the instance requires a service restart."),Object(n.b)("h3",{id:"create-the-administrator-credential"},"Create the Administrator Credential"),Object(n.b)("p",null,"The administrator will be BLUADMIN but you need to create a credential. Open the ",Object(n.b)("inlineCode",{parentName:"p"},"Service credentials")," panel for the Db2 instance resource you just created. If you don’t yet have any service credentials in the table at the bottom of the page, create a new one by clicking the ",Object(n.b)("inlineCode",{parentName:"p"},"New credential (+)")," button. Any name will do."),Object(n.b)("p",null,"To access the credential, select View Credentials for the entry you just created. The result will be a block of JSON full of secrets (blanked out here):"),Object(n.b)("pre",null,Object(n.b)("code",i({parentName:"pre"},{className:"language-json"}),'{\n  "hostname": "dashdb-txn-flex-.***********.services.dal.bluemix.net",\n  "password": "bluadmin-password-very-secret",\n  "https_url": "https://dashdb-txn-flex-************.services.dal.bluemix.net:8443",\n  "port": 50000,\n  "ssldsn": "DATABASE=BLUDB;HOSTNAME=dashdb-txn-flex-************.services.dal.bluemix.net;PORT=50001;PROTOCOL=TCPIP;UID=bluadmin;PWD=bluadmin-password-very-secret;Security=SSL;",\n  "host": "dashdb-txn-flex-************.services.dal.bluemix.net",\n  "jdbcurl": "jdbc:db2://dashdb-txn-flex-************.services.dal.bluemix.net:50000/BLUDB",\n  "uri": "db2://bluadmin:bluadmin-password-very-secret@dashdb-txn-flex-************.services.dal.bluemix.net:50000/BLUDB",\n  "db": "BLUDB",\n  "dsn": "DATABASE=BLUDB;HOSTNAME=dashdb-txn-flex-************.services.dal.bluemix.net;PORT=50000;PROTOCOL=TCPIP;UID=bluadmin;PWD=bluadmin-password-very-secret;",\n  "username": "bluadmin",\n  "ssljdbcurl": "jdbc:db2://dashdb-txn-flex-************.services.dal.bluemix.net:50001/BLUDB:sslConnection=true;"\n}\n')),Object(n.b)("p",null,"These properties are needed to deploy and manage the IBM FHIR Server schema."),Object(n.b)("h3",{id:"fhirserver-user-and-api-key"},"FHIRSERVER User and API Key"),Object(n.b)("p",null,"The ",Object(n.b)("strong",{parentName:"p"},"BLUADMIN")," user is used to deploy the initial schema objects (tables, indexes, stored procedures etc). Following the least-privilege principle, the FHIR server itself does not use ",Object(n.b)("strong",{parentName:"p"},"BLUADMIN"),". The FHIR server uses an API Key associated with an IAM Service Id. This Service Id is mapped to a Db2 user which is granted explicit privileges to the tables and stored procedures."),Object(n.b)("pre",null,Object(n.b)("code",i({parentName:"pre"},{}),"    API KEY -------\x3e Service Id -------\x3e DB2 User ------\x3e SELECT/UPDATE/EXECUTE etc Privileges\n (FHIR Config)          (IAM)              (DB2)                          (DB2)\n")),Object(n.b)("p",null,"On the IBM Cloud console, select Manage / Access (IAM)."),Object(n.b)("p",null,"Select the ",Object(n.b)("a",i({parentName:"p"},{href:"https://cloud.ibm.com/iam/serviceids"}),"Service IDs panel"),"."),Object(n.b)("p",null,"Wait for the table to populate. If you do not yet have an appropriate service id, click ",Object(n.b)("inlineCode",{parentName:"p"},"Create (+)")),Object(n.b)("p",null,"Specify a meaningful name and description. After creating the Service ID, record the ID value which will start with ",Object(n.b)("inlineCode",{parentName:"p"},"ServiceId-..."),"."),Object(n.b)("p",null,"Select the API keys tab on the Service ID management page. Note that this is not the ",Object(n.b)("inlineCode",{parentName:"p"},"IBM Cloud API keys")," on the left."),Object(n.b)("p",null,"Select ",Object(n.b)("inlineCode",{parentName:"p"},"Create (+)")," to add a new API key. Copy or download the key. If you mess up and don’t retain a copy, don’t panic - you can simply delete the API key and create a new one. API keys are designed to support rolling so you can add as many as you need and delete others if you need to revoke access for any reason."),Object(n.b)("p",null,"The API key is used in the database configuration section of the ",Object(n.b)("inlineCode",{parentName:"p"},"fhir-server-config.json")," file."),Object(n.b)("p",null,"Before the API key can be used, we need to create a Db2 user and associate it with the new ServiceId."),Object(n.b)("p",null,"Navigate to the IBM Cloud Db2 resource page for your instance and select Manage. Click Open Console to access the IBM Db2 on Cloud console."),Object(n.b)("p",null,"Select SETTINGS > Manage Users."),Object(n.b)("p",null,"Click Add. This opens a panel on the right-hand side."),Object(n.b)("p",null,"Select Add IBMid User at the top."),Object(n.b)("ul",null,Object(n.b)("li",{parentName:"ul"},Object(n.b)("p",{parentName:"li"},"User ID: FHIRSERVER")),Object(n.b)("li",{parentName:"ul"},Object(n.b)("p",{parentName:"li"},"IBMid: paste the ServiceId-… value from the Service Id created previously."))),Object(n.b)("p",null,"The page forces the value to lower-case, so ",Object(n.b)("inlineCode",{parentName:"p"},"ServiceId")," becomes ",Object(n.b)("inlineCode",{parentName:"p"},"serviceid"),". Don’t be alarmed, it still works."),Object(n.b)("p",null,"Do NOT select Administrator. One should follow the least-privelege principal for the FHIRSERVER user."),Object(n.b)("p",null,"Click Create."),Object(n.b)("p",null,"You should now be able to connect to the database as the FHIRSERVER user using only the API key created above."),Object(n.b)("h3",{id:"testing-the-connection"},"Testing the Connection"),Object(n.b)("p",null,"The Db2 driver jar contains a main which can be executed to test the connection - very convenient for checking the API-key/Service-Id/Db2-User-Id configuration is correct."),Object(n.b)("pre",null,Object(n.b)("code",i({parentName:"pre"},{className:"language-bash"}),'java -cp /path/to/db2jcc4.jar com.ibm.db2.jcc.DB2Jcc  -url "jdbc:db2://<DB2-HOSTNAME>:50001/BLUDB:apiKey=<API-KEY>;securityMechanism=15;sslConnection=true;sslTrustStoreLocation=/path/to/truststore.jks;sslTrustStorePassword=<TRUSTSTORE-PASSWORD>;"\n')),Object(n.b)("ul",null,Object(n.b)("li",{parentName:"ul"},Object(n.b)("inlineCode",{parentName:"li"},"<DB-HOSTNAME>"),": the hostname of your Db2 service from the Service Credentials page"),Object(n.b)("li",{parentName:"ul"},Object(n.b)("inlineCode",{parentName:"li"},"<API-KEY>"),": the API key value created in the previous section"),Object(n.b)("li",{parentName:"ul"},Object(n.b)("inlineCode",{parentName:"li"},"<TRUSTSTORE-PASSWORD>"),": the password for your truststore")),Object(n.b)("p",null,"Notes:\n1. Don’t forget the trailing ",Object(n.b)("inlineCode",{parentName:"p"},";")," in the URL. Some of the documented examples don’t include it, but it is required in order for the connection to work, although this may be fixed in a future driver release. This only affects this test URL, not the actual FHIR server configuration.\n2. When using an API Key, no username needs to be provided. This is because the API Key maps to a ServiceId, and that ServiceId is mapped to the Db2 user."),Object(n.b)("h3",{id:"configuring-a-liberty-datasource-with-api-key"},"Configuring a Liberty Datasource with API Key"),Object(n.b)("p",null,"The IBM FHIR Server Import/Export feature utilizes Java Batch (JSR-352) provided by the batch-1.0 feature in Liberty Profile. The persistence layer can be configured to use Db2 as follows:"),Object(n.b)("p",null,"Create a Db2 user (e.g. FHIRBATCH) and associate it with a ServiceId (no need to create an Administration user, a simple user has sufficient privileges). Using a valid API-KEY for the given ServiceId, configure a new datasource and the Java Batch persistence layer as follows:"),Object(n.b)("pre",null,Object(n.b)("code",i({parentName:"pre"},{className:"language-xml"}),'    <dataSource id="fhirbatchDS" jndiName="jdbc/fhirbatchDB">\n        <jdbcDriver libraryRef="fhirSharedLib"/>\n        <properties.db2.jcc\n            serverName="dashdb-txn-flex-************.services.dal.bluemix.net"\n            portNumber="50001"\n            apiKey="<API-KEY>"\n            securityMechanism="15"\n            pluginName="IBMIAMauth"\n            databaseName="BLUDB"\n            currentSchema="JBATCH"\n            driverType="4" sslConnection="true" sslTrustStoreLocation="resources/security/dbTruststore.jks" sslTrustStorePassword="<TRUSTSTORE-PASSWORD>"/>\n    </dataSource>\n\n    <batchPersistence jobStoreRef="BatchDatabaseStore" />\n    <databaseStore id="BatchDatabaseStore" dataSourceRef="fhirbatchDS" schema="JBATCH" tablePrefix="" />\n')),Object(n.b)("p",null,"Note, the Java Batch is configured in batchDs.xml  and included from the default server.xml that gets installed to the ",Object(n.b)("inlineCode",{parentName:"p"},"{wlp}/usr/server/fhir-server"),"."),Object(n.b)("h3",{id:"configuring-fhir-datasource"},"Configuring FHIR Datasource"),Object(n.b)("p",null,"The FHIR server uses a proxy datasource mechanism, allowing new datasources to be added at runtime without requiring a (Liberty Profile) server restart. To configure a FHIR tenant datasource using an API-KEY, use the following template:"),Object(n.b)("pre",null,Object(n.b)("code",i({parentName:"pre"},{className:"language-json"}),'        "persistence": {\n            "datasources": {\n                "default": {\n                    "tenantKey": "",\n                    "type": "db2",\n                    "connectionProperties": {\n                        "serverName": "dashdb-txn-flex-************.services.dal.bluemix.net",\n                        "portNumber": 50001,\n                        "databaseName": "BLUDB",\n                        "apiKey": "<API-KEY>",\n                        "securityMechanism": 15,\n                        "pluginName": "IBMIAMauth",\n                        "currentSchema": "FHIRDATA",\n                        "driverType": 4,\n                        "sslConnection": true,\n                        "sslTrustStoreLocation": "resources/security/dbTruststore.jks",\n                        "sslTrustStorePassword": "change-password"\n                    }\n                }\n            }\n        }\n')),Object(n.b)("h4",{id:"mapping-from-ibm-db2-on-cloud-endpoint-credentials"},"Mapping from IBM Db2 on Cloud Endpoint Credentials"),Object(n.b)("p",null,"This section explains how to populate the FHIR datasource from IBM Db2 on Cloud configuration details from an example configuration: "),Object(n.b)("p",null,"Use the following table to populate your datasource. "),Object(n.b)("table",null,Object(n.b)("thead",{parentName:"table"},Object(n.b)("tr",{parentName:"thead"},Object(n.b)("th",i({parentName:"tr"},{align:null}),"IBM FHIR Server Configuration"),Object(n.b)("th",i({parentName:"tr"},{align:null}),"Description"))),Object(n.b)("tbody",{parentName:"table"},Object(n.b)("tr",{parentName:"tbody"},Object(n.b)("td",i({parentName:"tr"},{align:null}),"serverName"),Object(n.b)("td",i({parentName:"tr"},{align:null}),"from the credential object select ",Object(n.b)("inlineCode",{parentName:"td"},"hostname"))),Object(n.b)("tr",{parentName:"tbody"},Object(n.b)("td",i({parentName:"tr"},{align:null}),"portNumber"),Object(n.b)("td",i({parentName:"tr"},{align:null}),"from the credential object select  ",Object(n.b)("inlineCode",{parentName:"td"},"port"))),Object(n.b)("tr",{parentName:"tbody"},Object(n.b)("td",i({parentName:"tr"},{align:null}),"databaseName"),Object(n.b)("td",i({parentName:"tr"},{align:null}),"from the credential object select  ",Object(n.b)("inlineCode",{parentName:"td"},"db"),", generally always ",Object(n.b)("inlineCode",{parentName:"td"},"BLUDB"))),Object(n.b)("tr",{parentName:"tbody"},Object(n.b)("td",i({parentName:"tr"},{align:null}),"apiKey"),Object(n.b)("td",i({parentName:"tr"},{align:null}),"from the created user in the assigned to the ",Object(n.b)("inlineCode",{parentName:"td"},"fhiruser")," group. Reference Section ",Object(n.b)("strong",{parentName:"td"},"FHIRSERVER User and API Key"))),Object(n.b)("tr",{parentName:"tbody"},Object(n.b)("td",i({parentName:"tr"},{align:null}),"securityMechanism"),Object(n.b)("td",i({parentName:"tr"},{align:null}),Object(n.b)("inlineCode",{parentName:"td"},"15")," generally set to 15 to trigger the ",Object(n.b)("inlineCode",{parentName:"td"},"apiKey")," use with IBM Cloud")),Object(n.b)("tr",{parentName:"tbody"},Object(n.b)("td",i({parentName:"tr"},{align:null}),"pluginName"),Object(n.b)("td",i({parentName:"tr"},{align:null}),Object(n.b)("inlineCode",{parentName:"td"},"IBMIAMauth")," fixed for use with the IBM Cloud")),Object(n.b)("tr",{parentName:"tbody"},Object(n.b)("td",i({parentName:"tr"},{align:null}),"currentSchema"),Object(n.b)("td",i({parentName:"tr"},{align:null}),"the schema name of your deployed tenant Schema, for instance ",Object(n.b)("inlineCode",{parentName:"td"},"FHIRDATA"))),Object(n.b)("tr",{parentName:"tbody"},Object(n.b)("td",i({parentName:"tr"},{align:null}),"driverType"),Object(n.b)("td",i({parentName:"tr"},{align:null}),Object(n.b)("inlineCode",{parentName:"td"},"4"),", always JDBC Type-4")),Object(n.b)("tr",{parentName:"tbody"},Object(n.b)("td",i({parentName:"tr"},{align:null}),"sslConnection"),Object(n.b)("td",i({parentName:"tr"},{align:null}),Object(n.b)("inlineCode",{parentName:"td"},"true"),", if you are using IBM Cloud")),Object(n.b)("tr",{parentName:"tbody"},Object(n.b)("td",i({parentName:"tr"},{align:null}),"sslTrustStoreLocation"),Object(n.b)("td",i({parentName:"tr"},{align:null}),"Local server path to the truststore, ",Object(n.b)("inlineCode",{parentName:"td"},"resources/security/dbTruststore.jks"))),Object(n.b)("tr",{parentName:"tbody"},Object(n.b)("td",i({parentName:"tr"},{align:null}),"sslTrustStorePassword"),Object(n.b)("td",i({parentName:"tr"},{align:null}),"The password to the truststore")))),Object(n.b)("ul",null,Object(n.b)("li",{parentName:"ul"},"Reference the section ",Object(n.b)("strong",{parentName:"li"},"Create the Administrator Credential")," to see an example. ")),Object(n.b)("p",null,"Note, no username properties are given, because the authentication module only requires the API-KEY."),Object(n.b)("h3",{id:"ssl-certificate"},"SSL Certificate"),Object(n.b)("p",null,"The Db2 certificate should be added to the Liberty Profile truststore. ",Object(n.b)("em",{parentName:"p"},"Be sure to use the same Java runtime that Liberty Profile uses when manipulating any keystores.")),Object(n.b)("h3",{id:"encrypt-secrets"},"Encrypt Secrets"),Object(n.b)("p",null,"All passwords including apiKey values should be encrypted using the Liberty Profile securityUtility."),Object(n.b)("h1",{id:"references"},"References"),Object(n.b)("ul",null,Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",i({parentName:"li"},{href:"https://cloud.ibm.com/docs/services/Db2onCloud?topic=Db2onCloud-db_details_cxn_creds"}),"Db2 on Cloud: Database details and connection credentials"))))}s.isMDXComponent=!0},Z3H1:function(e){e.exports=JSON.parse('{"data":{"site":{"siteMetadata":{"repository":{"baseUrl":"https://github.com/IBM/FHIR","subDirectory":"/docs"}}}}}')},pOBw:function(e){e.exports=JSON.parse('{"data":{"site":{"pathPrefix":"/FHIR"}}}')}}]);
//# sourceMappingURL=component---src-pages-guides-db-2-on-cloud-setup-md-6def784b204208d50f0c.js.map